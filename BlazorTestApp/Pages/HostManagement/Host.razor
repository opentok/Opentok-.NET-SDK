@page "/host"
@using BlazorTestApp.Data
@inject IJSRuntime JavascriptRuntime
@inject IVideoService VideoService
<PageTitle>Host</PageTitle>

<div class="container bump-me">

    <div class="body-content">

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Host</h3>
            </div>
            <div class="panel-body">
                Publishers
                <div id="publisher"></div>
            </div>
            <div class="panel-body">
                Subscribers
                <div id="subscribers">
                </div>
            </div>
            <div class="panel-footer">
                <button class="btn btn-success" onclick="@StartArchivingAsync" disabled="@isArchiving">Start archiving</button>
                <button class="btn btn-danger" onclick="@StopArchivingAsync" disabled="@(!isArchiving)">Stop archiving</button>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Instructions</h3>
        </div>
        <div class="panel-body">
            <p>
                Click <strong>Start archiving</strong> to begin archiving this session.
                All publishers in the session will be included, and all publishers that
                join the session will be included as well.
            </p>
            <p>
                Click <strong>Stop archiving</strong> to end archiving this session.
                You can then go to <a href="/archives">past archives</a> to
                view your archive (once its status changes to available).
            </p>
            <table class="table">
                <thead>
                <tr>
                    <th>When</th>
                    <th>You will see</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td style="vertical-align: middle;">Archiving is started</td>
                    <td>
                        <img src="/Content/img/archiving-on-message.png">
                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: middle;">Archiving remains on</td>
                    <td>
                        <img src="/Content/img/archiving-on-idle.png">
                    </td>
                </tr>
                <tr>
                    <td style="vertical-align: middle;">Archiving is stopped</td>
                    <td>
                        <img src="/Content/img/archiving-off.png">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {

    private string sessionId = string.Empty;
    private Guid archiveId = Guid.Empty;
    private bool isArchiving;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (!firstRender) return;
        var session = VideoService.CreateSession();
        sessionId = session.Id;
        await JavascriptRuntime.InvokeVoidAsync(
            "initializeSession",
            VideoService.GetApiKey().ToString(),
            sessionId,
            session.GenerateToken());
    }

    private async Task StartArchivingAsync()
    {
        isArchiving = true;
        var archive = await VideoService.StartArchiveAsync(sessionId);
        archiveId = archive.Id;
    }

    private async Task StopArchivingAsync()
    {
        isArchiving = false;
        if (archiveId != Guid.Empty)
        {
            await VideoService.StopArchiveAsync(archiveId);
        }
    }

}