@page "/archives"
@using BlazorTestApp.Data
@using OpenTokSDK
@inject OpenTokService Service
@inject NavigationManager NavigationManager
@inject IJSRuntime JavascriptRuntime
<PageTitle>Archives</PageTitle>

<div class="container bump-me">

    <div class="body-content">

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Past Archives</h3>
            </div>
            <div class="panel-body">
                @if (archiveCount > 0)
                {
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Created</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var archive in archives)
                        {
                            <tr data-item-id="@archive.Id">
                                <td>
                                    @archive.Name
                                </td>
                                <td>
                                    @{
                                        var epoch = new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
                                        @epoch.AddMilliseconds(archive.CreatedAt).ToString()
                                    }
                                </td>
                                <td>@archive.Duration seconds</td>
                                <td>@archive.Status</td>
                                <td>
                                    @if (archive.Status == ArchiveStatus.AVAILABLE)
                                    {
                                        <button class="btn btn-primary" onclick="@(async () => await DownloadArchiveAsync(archive.Id))">Download</button>
                                        <button class="btn btn-danger" onclick="@(async () => await DeleteArchiveAsync(archive.Id))">Delete</button>
                                    }
                                    else
                                    {
                                        @: &nbsp;
                                    }
                                </td>
                            </tr>
                        }

                        </tbody>
                    </table>
                }
                else
                {
                    <p>
                        Loading archives...
                    </p>
                }
            </div>
        </div>
    </div>
</div>

@code {

    private IEnumerable<Archive> archives = new List<Archive>();
    private int archiveCount;
    private string showPrevious = string.Empty;
    private string showNext = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var openTokArchives = await Service.OpenTok.ListArchivesAsync(count: 1000);
        if (openTokArchives != null)
        {
            archiveCount = openTokArchives.TotalCount;
            archives = openTokArchives.ToList();
        }
    }

    private async Task DownloadArchiveAsync(Guid archiveId)
    {
        var archive = await Service.OpenTok.GetArchiveAsync(archiveId.ToString());
        await JavascriptRuntime.InvokeVoidAsync("open", archive.Url, "_blank");
    }

    private async Task DeleteArchiveAsync(Guid archiveId)
    {
        await Service.OpenTok.DeleteArchiveAsync(archiveId.ToString());
        NavigationManager.NavigateTo(NavigationManager.Uri, true);
    }

}